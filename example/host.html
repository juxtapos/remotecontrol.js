<!DOCTYPE html>
<html>
<head>
	<title>remotecontrol.js: host application</title>
	<link rel="stylesheet" href="dist/remotecontrol.js.css" />
	<link rel="stylesheet" href="host.css" />
	<script src="dist/socket.io.min.js"></script>
	<script src="dist/remotecontrol.js.host.js"></script>
	<script>
	document.addEventListener('DOMContentLoaded', function () {
		init();
	});

	function init () {
		var options = { 
			url: location.host, 
			port: 1337,
			capture: ['touchmove', 'gesturechange', 'touchstart', 'touchend']
		}, 
		rch = new RemoteControlHost(options);

		var button = document.querySelector('.remotecontrol');
		button.addEventListener('click', function () { 
			rch.getToken();
			rch.addEventListener('receiveToken', function (data) {
				document.querySelector('#remotecontrol .tokenDisplay').innerHTML = data.tokenId;
			});
		});

		rch.addEventListener('gesturechange', gestureChangeHandler);
		rch.addEventListener('touchmove', touchmoveHandler);
		rch.addEventListener('touchstart', touchstartHandler);
		rch.addEventListener('touchend', touchendHandler);
	}


	function gestureChangeHandler (data) {
		var e = document.getElementById("box");
		e.style.webkitTransform = "rotate(" + data.rotation + "deg) scale(" + data.scale + ")"
		e.style.MozTransform = "rotate(" + data.rotation + "deg) scale(" + data.scale + ")"
	}

	function touchendHandler (data) {
		console.log(data);
		gestureHandler.end(data);
	}

	function touchstartHandler (data) {
		console.log(data);
		gestureHandler.start(data);
	}

	function touchmoveHandler (data) {
		for (var i = 0; i < data.touches.length; i++) {
			var e = document.getElementById('pointer' + (i+1));
			if (!data.touches) {
			} else {
				e.style.display = "block";
				e.style.left = data.touches[i].pageX + "px";
				e.style.top = data.touches[i].pageY + "px";
			}
		}
	}

	var gestureHandler = new GestureHandler();

	function GestureHandler () {
		var touches = {};

		function start (data) {
			data.changedTouches.forEach(function (t) { 
				touches[t.identifier] = { 
					touch: t, 
					timeStamp: new Date().getTime()
				};
			});

			var now = new Date().getTime(), notIn = 0;
			var TargetTouches = [];
			data.targetTouches.forEach(function (t) { 
				if (touches[t.identifier] && (now - touches[t.identifier].timeStamp > 1000)) {
					notIn += 1;
				}
			});

			console.log(data.targetTouches.length - notIn + ' touch');
		}

		function end (data) {

		}

		return {
			start: start,
			end: end
		}
	}

	
	</script>
	<style>
	
	</style>
</head>
<body>
	<div class="remotecontrol" id="remotecontrol">
		<div class="title">remotecontrol.js</div>
		<button>Get Token</button>
		<div class="tokenDisplay"></div>
	</div>

	<div id="box"></div>

	<div id="pointer1" class="pointer"></div>
	<div id="pointer2" class="pointer"></div>
	<div id="pointer3" class="pointer"></div>
	<div id="pointer4" class="pointer"></div>
</body>
</html>